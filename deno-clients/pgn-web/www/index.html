<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>DGT Board State Viewer</title>
    <script src="https://cdn.jsdelivr.net/npm/chess.js@0.11.0/chess.min.js"></script>

    <script
      src="https://code.jquery.com/jquery-3.5.1.min.js"
      integrity="sha384-ZvpUoO/+PpLXR1lu4jmpXWu80pZlYUAfxl5NsBMWOEPSjUn/6Z/hRTt8+pR6L4N2"
      crossorigin="anonymous"
    ></script>
    <link
      rel="stylesheet"
      href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css"
      integrity="sha384-q94+BZtLrkL1/ohfjR8c6L+A6qzNH9R2hBLwyoAfu3i/WCvQjzL2RQJ3uNHDISdU"
      crossorigin="anonymous"
    />
    <script
      src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"
      integrity="sha384-8Vi8VHwn3vjQ9eUHUxex3JSN/NFqUg3QbPyX8kWyb93+8AC/pPWTzj+nHtbC5bxD"
      crossorigin="anonymous"
    ></script>
    <script src="/groq.js"></script>
  </head>
  <body>
    <div id="webBoard" style="width: 400px; display: inline-block"></div>
    <div id="dgtBoard" style="width: 400px; display: inline-block"></div>
    <div id="myPgn" style="width: 400px"></div>
    <script>
      window.chess = new Chess();
      window.webBoard = Chessboard("webBoard", {
        // pieceTheme: 'img/chesspieces/alpha/{piece}.png',
        pieceTheme:
          "https://chessboardjs.com/img/chesspieces/alpha/{piece}.png",
      });

      window.dgtBoard = Chessboard("dgtBoard", {
        // pieceTheme: 'img/chesspieces/alpha/{piece}.png',
        pieceTheme:
          "https://chessboardjs.com/img/chesspieces/alpha/{piece}.png",
      });

      var myPgn = document.getElementById("myPgn");

      const pieces = [
        ".",
        "P",
        "R",
        "N",
        "B",
        "K",
        "Q",
        "p",
        "r",
        "n",
        "b",
        "k",
        "q",
      ];

      const fenish = (position) =>
        position
          .map((i) => pieces[i])
          .join("")
          .split(/(........)/g)
          .filter((i) => !!i)
          .join("/")
          .replace(/\.+/g, (all) => all.length);

      const fenish64 = fen => fen.replace(/\//g, '').replace(/\d/g, all => Array(all * 1).fill('.').join(''))

      void (async () => {
        window.everything = await fetch("/everything").then((r) => r.json());
        const positions = (
          await (
            await groq.evaluate(groq.parse(`*[position != null][].position`), {
              dataset: everything,
            })
          ).get()
        )
        const fens = positions.map(fenish);
        console.log(fens);
        const { fens: lastGameFens } = fens.reduce(
          (memo, discard, index, all) => {
            if (!memo.done) {
              const next = all[all.length - index - 1];
              if (next === "rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR") {
                memo.done = true;
              }
              memo.fens.unshift(next);
            }
            return memo;
          },
          { done: false, fens: [] }
        );

        console.log(lastGameFens)
        console.log(lastGameFens.map(fenish64))

      })();

      const pipe = new WebSocket(`ws://${location.host}/socket`);
      // pipe.addEventListener("open", fire);
      // pipe.addEventListener("close", fire);
      // pipe.addEventListener("message", fire);
      // pipe.addEventListener("error", fire);
      pipe.addEventListener("message", (ev) => {
        console.log(ev);
        const msg = JSON.parse(ev.data);

        if (
          msg.position &&
          msg.position.toString() ===
            "8,9,10,12,11,10,9,8,7,7,7,7,7,7,7,7,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,2,3,4,6,5,4,3,2"
        ) {
          dgtBoard.position(fenish(msg.position));
          chess.reset();
          webBoard.position(chess.fen());
          webBoard.orientation("white");
          console.log(chess.ascii());
          myPgn.innerText = chess.pgn();
        } else if (msg.position) {
          console.log(msg.position);
          console.log(fenish(msg.position));
          dgtBoard.position(fenish(msg.position));
        } else if (msg.move) {
          const { from, to } = msg.move;
          chess.move({ from, to });
          webBoard.position(chess.fen());
          // webBoard.flip()
          console.log(chess.ascii());
          myPgn.innerText = chess.pgn();
        }
      });

      // socket.on('connected', function(msg) {
      //   console.log({ msg })
      // });
    </script>
  </body>
</html>
